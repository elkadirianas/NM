<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Evaluation Details</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container my-5">
  <h1 class="text-center mb-4" th:text="'Evaluation: ' + ${evaluation.evaluationMode}"></h1>

  <!-- Table for students -->
  <table class="table table-bordered table-hover table-striped">
    <thead class="table-dark">
    <tr>
      <th>Student ID</th>
      <th>Name</th>
      <th>Surname</th>
      <th>Mark</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="student : ${students}">
      <td th:text="${student.id}"></td>
      <td th:text="${student.name}"></td>
      <td th:text="${student.surname}"></td>
      <td>
        <input type="number" class="form-control" name="marks"
               th:attr="data-student-id=${student.id}, data-evaluation-id=${evaluation.id}" />
      </td>

    </tr>
    </tbody>
  </table>

  <button class="btn btn-primary" id="submitMarks">Submit Marks</button>
</div>

<script>
  document.getElementById('submitMarks').addEventListener('click', function() {
    const marks = [];
    let isValid = true;

    document.querySelectorAll('input[name="marks"]').forEach(input => {
      const mark = parseFloat(input.value);
      if (isNaN(mark)) {
        isValid = false;
        alert('Please enter valid marks for all students.');
        return;
      }

      marks.push({
        studentId: input.getAttribute('data-student-id'),
        evaluationId: input.getAttribute('data-evaluation-id'),
        mark: mark
      });
    });

    if (!isValid) return;

    console.log(JSON.stringify(marks)); // Log the payload

    fetch('/Dashboard/prof/saveMarks', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(marks)
    })
            .then(response => {
              if (response.ok) {
                alert('Marks submitted successfully!');
              } else {
                response.text().then(errorMessage => {
                  console.error(errorMessage); // Log error details
                  alert('Error submitting marks.');
                });
              }
            });
  });
</script>
</body>
</html>
